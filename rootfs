#!/bin/bash

################################################################################
# HELPER: YES / NO / HELP
################################################################################

whiptail_yes_no_help() {
    local TITLE="$1"
    local QUESTION="$2"
    local HELP_TEXT="$3"

    while true; do
        CHOICE=$(whiptail --title "$TITLE" --menu \
"$QUESTION" 18 90 3 \
"Yes"  "Proceed" \
"No"   "Skip" \
"Help" "Show detailed explanation" \
3>&1 1>&2 2>&3)

        case "$CHOICE" in
            Yes)  return 0 ;;
            No)   return 1 ;;
            Help) whiptail --title "Help" --msgbox "$HELP_TEXT" 25 90 ;;
        esac
    done
}

################################################################################
# SCRIPT FLOW (HELP ONLY)
################################################################################

whiptail --title "RootFS Script Flow" --msgbox "
Step 1: Prepare Working Directory (Automatic)
- Creates required directories
- Moves into the rootfs working directory

Step 2: Find Latest RootFS Image (Automatic)
- Connects to the rootfs server
- Detects the latest date-based folder
- Detects the latest AM335x image
- Exits if nothing is found

Step 3: Download Image (Automatic)
- If image already exists → skipped
- Otherwise → downloaded automatically

Step 4: Extract Image (Automatic)
- Extracts .img from compressed archive
- Keeps the compressed file
- Skips extraction if already done

Step 5: Mount Option (User Interaction)
Step 6: Unmount Option (User Interaction)
" 25 90

################################################################################
# CONFIGURATION
################################################################################

BASE_DIR=~/linux_training/bbb-project/10_rootfs
ROOTFS_DIR=$BASE_DIR/rootfs
MOUNT_DIR=$ROOTFS_DIR/mnt
RCN_BASE_URL="https://rcn-ee.com/rootfs/debian-armhf-12-bookworm-iot-v6.1-ti/"

mkdir -p "$ROOTFS_DIR"
cd "$ROOTFS_DIR"

echo "Searching for latest dated folder..."

################################################################################
# STEP 2: FIND LATEST ROOTFS
################################################################################

latest_folder=$(curl -s "$RCN_BASE_URL" | grep -oP '\d{4}-\d{2}-\d{2}/' | sort -Vr | head -n1)

if [[ -z "$latest_folder" ]]; then
    whiptail --msgbox "[✗] Failed to find a valid rootfs folder." 10 60
    exit 1
fi

full_url="${RCN_BASE_URL}${latest_folder}"
echo "Latest folder: $latest_folder"

image_filename=$(curl -s "$full_url" | grep -oP 'am335x-debian-.*?\.img\.xz' | sort -Vr | head -n1)

if [[ -z "$image_filename" ]]; then
    whiptail --msgbox "[✗] No rootfs image found." 10 60
    exit 1
fi

download_url="${full_url}${image_filename}"

echo "[✔] Latest image: $image_filename"
echo "Download URL: $download_url"

################################################################################
# STEP 3: DOWNLOAD
################################################################################

if [ -f "$image_filename" ]; then
    echo "[✔] Image already exists. Skipping download."
else
    echo "Downloading image..."
    wget "$download_url"
fi

################################################################################
# STEP 4: EXTRACT
################################################################################

extracted_img="${image_filename%.xz}"

if [ -f "$extracted_img" ]; then
    echo "[✔] Already extracted: $extracted_img"
else
    echo "Extracting image..."
    xz -dk "$image_filename"
fi

################################################################################
# STEP 5: MOUNT OPTION (WITH HELP)
################################################################################

HELP_MOUNT="
Press YES when:
- You want to inspect or modify the root filesystem
- You want to view the partition layout
- The script will:
  • Detect Linux partition offset
  • Calculate byte offset
  • Mount using loopback

Press NO when:
- You only want the image file

Result:
- Root filesystem becomes accessible at:
  $MOUNT_DIR
"

if whiptail_yes_no_help \
"Mount RootFS" \
"Mount and explore the root filesystem now?" \
"$HELP_MOUNT"; then

    fdisk -l "$extracted_img"

    PART_OFFSET=$(fdisk -l "$extracted_img" | grep -m 1 -E "^[^:]+img[0-9]+" | awk '{print $3}')
    OFFSET_BYTES=$((PART_OFFSET * 512))

    mkdir -p "$MOUNT_DIR"

    if mount | grep -q "$MOUNT_DIR"; then
        echo "⚠️ Already mounted."
    else
        sudo mount -o loop,offset=$OFFSET_BYTES "$extracted_img" "$MOUNT_DIR"
        echo "[✔] Mounted at $MOUNT_DIR"
    fi
fi

################################################################################
# STEP 6: UNMOUNT OPTION (WITH HELP)
################################################################################

HELP_UNMOUNT="
Press YES when:
- You are done exploring the root filesystem

Press NO when:
- You want to keep it mounted

Note:
After unmounting, copy rootfs to SD card using:
sudo cp -r $MOUNT_DIR /media/\$(whoami)/root
"

if whiptail_yes_no_help \
"Unmount RootFS" \
"Unmount root filesystem if mounted?" \
"$HELP_UNMOUNT"; then
    if mount | grep -q "$MOUNT_DIR"; then
        sudo umount "$MOUNT_DIR"
        echo "[✔] Unmounted successfully."
    else
        echo "Rootfs is not mounted."
    fi
fi

################################################################################
# DONE
################################################################################

whiptail --msgbox \
"Rootfs setup completed successfully!

Rootfs directory:
$ROOTFS_DIR

Image file:
$image_filename
" 14 90
